name: Deploy to Sepolia

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for deployment (e.g., "Initial deployment", "Bug fix", "Feature update")'
        required: true
        type: string

env:
  NODE_VERSION: '20.19.5'

jobs:
  deploy:
    name: Deploy Contract
    runs-on: ubuntu-latest
    environment: sepolia

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run build

      - name: Deploy to Sepolia
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.SEPOLIA_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          SEPOLIA_OWNER_ADDRESS: ${{ secrets.SEPOLIA_OWNER_ADDRESS }}
          SEPOLIA_FEE_RECIPIENT: ${{ secrets.SEPOLIA_FEE_RECIPIENT }}
        run: npm run deploy:sepolia

      - name: Verify on Etherscan
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.SEPOLIA_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: npm run verify:sepolia
        continue-on-error: true

      - name: Read deployment info
        id: deployment
        run: |
          PROXY=$(node -e "const d = require('./deployments.json'); console.log(d.sepolia?.proxy || 'unknown')")
          IMPL=$(node -e "const d = require('./deployments.json'); console.log(d.sepolia?.implementation || 'unknown')")
          echo "proxy=$PROXY" >> $GITHUB_OUTPUT
          echo "implementation=$IMPL" >> $GITHUB_OUTPUT

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sepolia-deployment
          path: |
            deployments.json
            .openzeppelin/sepolia.json
          retention-days: 30

      - name: Update README with deployment info
        run: npm run update-readme

      - name: Create PR with README update
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update README with Sepolia deployment info"
          title: "📝 Update README - Sepolia Deployment"
          body: |
            ## Sepolia Deployment Complete

            This PR updates the README with Sepolia deployment information.

            **Proxy:** `${{ steps.deployment.outputs.proxy }}`
            **Implementation:** `${{ steps.deployment.outputs.implementation }}`
            **Deployed by:** @${{ github.actor }}
            **Reason:** ${{ github.event.inputs.reason }}

            Merge this to publish the deployment info in the README.
          branch: sepolia-deployment-${{ github.run_number }}
          delete-branch: true

      - name: Create deployment summary
        run: |
          echo "## 🚀 Sepolia Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Proxy Address:** [\`${{ steps.deployment.outputs.proxy }}\`](https://sepolia.etherscan.io/address/${{ steps.deployment.outputs.proxy }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Implementation:** [\`${{ steps.deployment.outputs.implementation }}\`](https://sepolia.etherscan.io/address/${{ steps.deployment.outputs.implementation }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** Sepolia (Chain ID: 11155111)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "✅ README update PR created - review and merge to publish deployment info" >> $GITHUB_STEP_SUMMARY
